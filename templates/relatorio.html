<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio DNIT 008 - Detalhado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .conceito-badge { font-weight: bold; padding: 4px 8px; border-radius: 4px; color: #fff; text-transform: uppercase; font-size: 0.8em;}
        .bg-√ìtimo { background-color: #28a745; }
        .bg-Bom { background-color: #9cdb43; color: #000; }
        .bg-Regular { background-color: #ffc107; color: #000; }
        .bg-Ruim { background-color: #fd7e14; }
        .bg-P√©ssimo { background-color: #dc3545; }
        
        .memoria-calc { font-size: 0.85em; }
        .memoria-calc th { background-color: #e9ecef; }
        .img-tabela { border: 1px solid #dee2e6; border-radius: 5px; transition: transform 0.2s; }
        .img-tabela:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold">Relat√≥rio T√©cnico - DNIT 008/2003</h1>
            <p class="text-muted mb-0">Avalia√ß√£o Objetiva da Superf√≠cie (IGGE, IES, ICPF)</p>
        </div>
        <div class="d-print-none">
            <a href="/" class="btn btn-outline-secondary btn-sm">Nova An√°lise</a>
            <button onclick="window.print()" class="btn btn-primary btn-sm">üñ®Ô∏è Imprimir / PDF</button>
            <a href="{{ url_for('exportar_relatorio', id=resultados[0]['upload_id']) }}" class="btn btn-success btn-sm ms-2">
                <i class="bi bi-file-earmark-spreadsheet"></i> Baixar Anexo em Excel
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0">Evolu√ß√£o dos Indicadores (Clique na legenda para filtrar)</h5>
        </div>
        <div class="card-body">
            <canvas id="mainChart" height="100"></canvas>
            <div class="text-center mt-2 small text-muted">
                <span class="badge bg-primary">IGGE</span> Eixo Esquerdo (0-500) &nbsp;|&nbsp; 
                <span class="badge bg-warning text-dark">IES</span> <span class="badge bg-success">ICPF</span> Eixo Direito (0-10)
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-dark text-white">Quadro Resumo (Resultados por Segmento)</div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead>
                    <tr>
                        <th>Segmento</th>
                        <th>Trincas</th>
                        <th>Deform.</th>
                        <th>Panelas</th>
                        <th class="table-primary">IGGE</th>
                        <th class="table-success">ICPF</th>
                        <th class="table-warning">IES</th>
                        <th>Conceito</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in resultados %}
                    <tr>
                        <td>km {{ row.km_inicial }}</td>
                        <td>{{ row.freq_trincas }}</td>
                        <td>{{ row.freq_deformacoes }}</td>
                        <td>{{ row.freq_panelas }}</td>
                        <td class="fw-bold table-primary">{{ "%.0f"|format(row.igge) }}</td>
                        <td class="table-success">{{ row.icpf }}</td>
                        <td class="table-warning">{{ row.ies }}</td>
                        <td><span class="conceito-badge bg-{{ row.conceito }}">{{ row.conceito }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <h5 class="mb-3 text-muted border-bottom pb-2">Mem√≥ria de C√°lculo Detalhada</h5>
    <div class="card shadow-sm mb-5">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped memoria-calc mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2">Seg. (km)</th>
                            <th colspan="3">Trincas (Peso 0.35)</th>
                            <th colspan="3">Deforma√ß√µes (Peso 0.60)</th>
                            <th colspan="2">Panelas (Peso 0.70)</th>
                            <th rowspan="2">F√≥rmula IGGE</th>
                        </tr>
                        <tr>
                            <th>Qtd/√Årea</th>
                            <th>%</th>
                            <th>Fat</th>
                            <th>Qtd/√Årea</th>
                            <th>%</th>
                            <th>Fat</th>
                            <th>Qtd.</th>
                            <th>Fat</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in resultados %}
                        <tr>
                            <td class="fw-bold">{{ row.km_inicial }}</td>
                            
                            <td class="small">{{ "%.1f"|format(row.qtd_trincas) }}m¬≤</td>
                            <td>{{ "%.1f"|format(row.pct_trincas) }}%</td>
                            <td class="fw-bold">{{ row.freq_trincas }} <span class="text-muted fw-normal">({{ row.grav_trincas }})</span></td>

                            <td class="small">{{ "%.1f"|format(row.qtd_deformacoes) }}m¬≤</td>
                            <td>{{ "%.1f"|format(row.pct_deformacoes) }}%</td>
                            <td class="fw-bold">{{ row.freq_deformacoes }} <span class="text-muted fw-normal">({{ row.grav_deformacoes }})</span></td>

                            <td>{{ row.qtd_panelas }}</td>
                            <td class="fw-bold">{{ row.freq_panelas }} <span class="text-muted fw-normal">({{ row.grav_panelas }})</span></td>

                            <td class="text-start font-monospace small" style="font-size: 0.75em;">
                                ({{ row.grav_trincas }} √ó {{ "%.1f"|format(row.pct_trincas) }}) + <br>
                                
                                ({{ row.grav_deformacoes }} √ó {{ "%.1f"|format(row.pct_deformacoes) }}) + <br>
                                
                                ({{ row.grav_panelas }} √ó {{ row.qtd_panelas }}) <br>
                                
                                = <b>{{ "%.0f"|format(row.igge) }}</b>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="d-print-break-before"> 
        <h4 class="mb-4 text-primary fw-bold">Anexos: Tabelas de Refer√™ncia (DNIT 008/2003)</h4>
        
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Tabela 1 - Frequ√™ncia</div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='Tabela1.png') }}" class="img-fluid img-tabela" alt="Tabela 1">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Tabela 2 e 3 - Conceitos e Gravidade</div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='Tabela2.png') }}" class="img-fluid img-tabela mb-2" alt="Tabela 2">
                        <img src="{{ url_for('static', filename='Tabela3.png') }}" class="img-fluid img-tabela" alt="Tabela 3">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Tabela 4 - Pesos Ponderados</div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='Tabela4.png') }}" class="img-fluid img-tabela" alt="Tabela 4">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Tabela 5 - Matriz de Decis√£o (IES)</div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='Tabela5.png') }}" class="img-fluid img-tabela" alt="Tabela 5">
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const chartData = {{ chart_data | tojson }};
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar', 
        data: chartData,
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(1);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'IGGE (Escala 0-100)' },
                    suggestedMax: 150,
                    grid: { drawOnChartArea: false } 
                },
                y1: { 
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'IES / ICPF (Escala 0-10)' },
                    min: 0,
                    max: 10,
                    grid: { drawOnChartArea: true }
                }
            }
        }
    });
</script>

</body>
</html>